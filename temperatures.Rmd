---
title: "Final project - Temperatures"
author: "Nikola Grlj"
date: "2/4/2022"
output: html_document
---

Load all necessary packages
```{r, echo=FALSE, message=FALSE}
library (plyr)
library(tidyverse)
library(sf)
library(ggplot2)
library(stars)
library(gstat)
library(lubridate)
library(spacetime)
library(sp)
library(stringr)
library(maps)
library(rnaturalearth)
library(ggrepel)
```

Import stations
```{r, echo=FALSE, message=FALSE}
stations <- read_csv("stations.csv")
```

Round all dates down to year
```{r, echo=FALSE, message=FALSE}
stations$YEAR <- floor_date(stations$DATE, "year")
```

Temperature is in Fahrenheight so let's convert it to Celsius degrees
```{r, echo=FALSE, message=FALSE}
stations$TEMP <- (((stations$TEMP)-32)/1.8)
```

We need to aggregate data so we get annual mean (from daily means), so we will have annual daily mean for every station for all years.
```{r, echo=FALSE, message=FALSE}
agg = aggregate(stations$TEMP,list(YEAR = stations$YEAR,STATION_ID = stations$STATION,NAME = stations$NAME,LAT = stations$LATITUDE,LONG = stations$LONGITUDE,ELEVATION = stations$ELEVATION), mean)
colnames(agg)[which(names(agg) == "x")] <- "MEAN_TEMP"
agg <- agg[order(agg$YEAR), ]
agg$YEAR <- format(as.Date(agg$YEAR, format="%d/%m/%Y"),"%Y")
agg$STATION_ID <- substring(agg$STATION_ID,1,5)
```

There are 32 possible stations:
```{r, echo=FALSE, message=FALSE}
print(unique(agg$NAME))
```

Now we have issue because it seems that not every year has data for every station.
We can check that in the following way:
```{r, echo=FALSE, message=FALSE}
checker <- function(input_file) {
counter <- 0
full_counter <- 0
stations <- c()
my_list <- c()
differences <- c()
for (unique_year in unique(input_file$YEAR)) {
  for (year in input_file$YEAR) {
    if (unique_year == year) {
      counter = counter + 1
      full_counter = full_counter + 1
      stations[length(stations)+1] <- input_file$STATION_ID[full_counter]
    }
  }
  difference <- setdiff(unique(input_file$STATION_ID),stations)
  print(difference)
  differences[(length(differences)+1)] <- paste(unlist(difference),collapse=",")
  my_list[(length(my_list)+1)] <- counter
  counter <- 0
  stations <- c()
}
n_stations_by_year <- data.frame(YEAR = unique(input_file$YEAR),N_stations = my_list, DIFFERENCE_ID = differences)
return(n_stations_by_year)
}
checker(agg)
```

To make things coherent (I'm not sure if this is correct way) we will remove records for year 2005. and also all records for stations 14442 and 14446. Station "Portoroz" is in Slovenia so it has to be removed as well.
Let's include only data we need:
```{r, echo=FALSE, message=FALSE}
agg2 <- subset(agg, YEAR != "2005" )
agg3 <- subset(agg2, STATION_ID != "14442")
agg4 <- subset(agg3, STATION_ID != "14446")
```
Now we should have dataset without year 2005 and without station 14324. Let's check if that's correct:
```{r, echo=FALSE, message=FALSE}
checker(agg4)
```
As we can see, now all years have same stations (30 of them). Next thing we can do is create space-time object STFDF.


Create space-time object STFDF
```{r, echo=FALSE, message=FALSE}
station_coords_df <- cbind(LON = agg4$LONG[1:30], LAT = agg4$LAT[1:30])
row.names(station_coords_df) <- paste(agg4$NAME[1:30])
station_coords <- SpatialPoints(station_coords_df)
time <- as.POSIXct(unique(agg4$YEAR),tz="", "%Y")
values <- agg4$MEAN_TEMP
IDs <- paste("ID", 1:length(agg4$MEAN_TEMP), sep = "_")
df <- data.frame(values = values, ID = IDs)
st_object <- STFDF(station_coords,time,data=df)
```
Load Croatian map
```{r, echo=FALSE, message=FALSE}
croatia_sea <- st_read("HRV_adm/croatia.geojson")
croatia_land <- st_read("HRV_adm/croatia_land.geojson")
single_sf <- bind_rows(list(croatia_sea,croatia_land))
```

Create map for Croatia together with stations. I don't know how to add labels.
```{r Croatia map, fig.align='center',fig.width=10, fig.height=7, include=TRUE, results='hide'}
stations_sf <- st_as_sf(station_coords)
stations_sf$STATION <- row.names(station_coords)
st_crs(stations_sf) = 4326
plot_with_points <- ggplot() +
  geom_sf(data = single_sf) +
  geom_point(data = stations_only,
             mapping = aes(x = LONG, y = LAT),
             colour = "red",
             size = 6,
             shape = 4) +
  coord_sf()

plot_with_points + 
  geom_label_repel(data = stations_only, aes(x = LONG, y = LAT,label = NAME),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  segment.color = 'grey50') +
  theme_classic()
```
For some reason, grid is created for rectangle and for Croatian boundaries. There are different values inside grid cells depending one the position of cell. I will assign NA value to cells outside Croatian boundary, and value 0 to cells inside Croatia.
```{r, echo=FALSE, message=FALSE}
croatia_grid_sf <- st_read("Croatia_shapefile/hr_10km.shp")
croatia_bbox <- st_as_sfc(st_bbox(croatia_grid_sf))
croatia_outer_border <- st_intersection(croatia_bbox,croatia_grid_sf)
croatia_grid_stars <- st_as_stars(croatia_outer_border, dx = 10000)
for (x in 1:54) {
  for (y in 1:57) {
    if (croatia_grid_stars[[1]][x:x,y:y] == 0) {
      croatia_grid_stars[[1]][x:x,y:y] <- NA
    } 
    else {
      croatia_grid_stars[[1]][x:x,y:y] <- 0
    }
  }
}
```

