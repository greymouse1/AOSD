---
title: "Final project - Temperatures"
author: "Nikola Grlj"
date: "2/4/2022"
output: html_document
---
# Spatio-temporal interpolation of mean temperature values for Croatia in period 2004-2020

### Summary
1. Introduction
  + motivation
  + datasets
  + related work
  + research questions
2. Methods
  + which methods
  + why
3. Results
  + presentation of results
4. Discussion and conclusion
  + do assumptions hold
  + strengths and weaknesses
5. References

Load all necessary packages
```{r Load all packages, echo=FALSE, message=FALSE}
library(plyr)
library(tidyverse)
library(sf)
library(ggplot2)
library(stars)
library(gstat)
library(lubridate)
library(spacetime)
library(sp)
library(stringr)
library(maps)
library(rnaturalearth)
library(ggrepel)
library(RColorBrewer)
library(xts)
library(maptools)
```
# Spatio-temporal interpolation of mean temperature values for Croatia in period 2004-2020

### Summary
1. **Introduction**
  + motivation
  + datasets
  + related work
  + research questions
2. **Methods**
  + which methods
  + why
3. **Results**
  + presentation of results
4. **Discussion and conclusion**
  + do assumptions hold
  + strengths and weaknesses
5. **References**

## 1. Introduction

Nowadays, global warming is taken as an undeniable truth, being confirmed by multiple studies across the globe. Rising temperatures can have negative effects on likelihod of different populations around the world, mainly by affecting conditions for growing foods, disturbing sensitive ecosystems, and rising sea levels. Croatia is consisted of three distinctive parts; continental part, mountainous part and coastal part. Each one of them has different climate and temperatures even though whole country is classified as having continental climate and coast hosting mediterannean climate. We would like to have a sense of how climate change and increasing temperatures affect different parts of Croatia, which can be used as a strarting point for more detailed research in order to plan mitigation measures for possible negative effects of increasing temperatures.
With wide availability of sensors which measure atmospheric conditions, we can access data for desired area and inquire on how temperatures affect that area.
In this work, we will look at temperature data recorded on 30 stations on the territory of Republic of Croatia, starting in 2004. and ending in 2020. Data is provided by NOAA (National Oceanic and Atmospheric Administration)[1]. Inspiration was taken from two papers, Spatio-temporal regression kriging model of mean daily temperature for Croatia by Sekulić et al. [2] and Spatio-temporal prediction of daily temperatures using time-series of MODIS LST images by Hengl et al. [3]. Other work which was used as and aid in writing code and structuring data processing was vignettes for **gstat** and **spacetime**, as well as tutorial on spatio-temporal krigging [4]

In this work, we want to answer the following questions:
  * Is there a trend of rising temperature in Croatia?
  * If there is, which areas are affected by this and how?
  * By looking at the results of krigging, can we notice any factors which may influence temperature on the territory of Croatia, for example altitude, latitude, proximity to sea or anything else, which could be used for another study (kriging with multiple variables)?

## 2. Methods
Method I'm going to use is ordinary spatio-temporal kriging. ----Don't know why this is best yet---
In order to be able to perform kriging, I need to model a spatio-temporal variogram. In usual case of purely spatial kriging, matrix of covariances is consisted only of spatial distances between stations. In my case, temporal distance has to be taken into account as well. Workflow will have the following order:
1. Download data
2. Process data (I selected only stations and years which have complete data)
3. Create STFDF object which holds station coordinates, yearly average temperature readings for these stations and their timestamps

From this data we will then be able to model:
4. Sample spatio-temporal variogram (for all years and all stations)
5. Find the best fitting model for sample variogram
6. Create spatio-temporal prediction grid to be used for kriging
7. Perform kriging

Main packages I will be using are **gstat** package which provides functions for geostatistical analysis (creating sample and model variogram, and fitting latter to the former), and **spacetime** package (used for creating structured spatio-temporal data which serves as input for modelling variograms and later performing kriging).



Import stations
```{r Import stations, echo=TRUE, message=FALSE}
stations <- read_csv("stations2.csv")
```

Round all dates down to year
```{r Round all dates, echo=TRUE, message=FALSE}
stations$YEAR <- floor_date(stations$DATE, "year")
```

Temperature is in Fahrenheight so let's convert it to Celsius degrees
```{r Temperature conversion, echo=TRUE, message=FALSE}
stations$TEMP <- (((stations$TEMP)-32)/1.8)
```

We need to aggregate data so we get annual mean (from daily means), so we will have annual daily mean for every station for all years.
```{r Aggregate by year, echo=TRUE, message=FALSE}
agg = aggregate(stations$TEMP,list(YEAR = stations$YEAR,STATION_ID = stations$STATION,NAME = stations$NAME,LAT = stations$LATITUDE,LONG = stations$LONGITUDE,ELEVATION = stations$ELEVATION), mean)
colnames(agg)[which(names(agg) == "x")] <- "MEAN_TEMP"
agg <- agg[order(agg$YEAR), ]
agg$YEAR <- format(as.Date(agg$YEAR, format="%d/%m/%Y"),"%Y")
agg$STATION_ID <- substring(agg$STATION_ID,1,5)
```

There are 32 possible stations:
```{r Show stations, echo=TRUE}
print(unique(agg$NAME))
```

Now we have issue because it seems that not every year has data for every station.
We can check that in the following way:
```{r Check for missing data, echo=TRUE}
checker <- function(input_file) {
counter <- 0
full_counter <- 0
stations <- c()
my_list <- c()
differences <- c()
for (unique_year in unique(input_file$YEAR)) {
  for (year in input_file$YEAR) {
    if (unique_year == year) {
      counter = counter + 1
      full_counter = full_counter + 1
      stations[length(stations)+1] <- input_file$STATION_ID[full_counter]
    }
  }
  difference <- setdiff(unique(input_file$STATION_ID),stations)
  print(difference)
  differences[(length(differences)+1)] <- paste(unlist(difference),collapse=",")
  my_list[(length(my_list)+1)] <- counter
  counter <- 0
  stations <- c()
}
n_stations_by_year <- data.frame(YEAR = unique(input_file$YEAR),N_stations = my_list, DIFFERENCE_ID = differences)
return(n_stations_by_year)
}
checker(agg)
```

To make things coherent (I'm not sure if this is correct way) we will remove records for year 2005. and also all records for stations 14442 and 14446.
Let's include only data we need:
```{r Clean data, echo=TRUE, message=FALSE}
agg4 <- subset(agg, YEAR != "2005" & STATION_ID != "14442" & STATION_ID != "14446")
```
Now we should have dataset without year 2005(some stations missing data) and 2020(data available only for 1. January), and without stations 14442 and 14446. Let's check if that's correct:
```{r Check data again, echo=TRUE}
checker(agg4)
```
As we can see, now all years have same stations (30 of them). Next thing we can do is create space-time object STFDF.


Create space-time object STFDF
```{r Create STFDF object, echo=TRUE, message=FALSE, warning=FALSE}
# Get station names and coordinates(LON-LAT in WGS84)
station_coords_df <- cbind(LON = agg4$LONG[1:30], LAT = agg4$LAT[1:30])
row.names(station_coords_df) <- paste(agg4$NAME[1:30])
station_coords <- SpatialPoints(station_coords_df,CRS("+init=epsg:4326"))

# Transform coordinates to projection for Croatia
station_coords <- spTransform(station_coords, CRS("+init=epsg:3765"))
# Check for duplicates. If we have duplicates, kriging won't work because we get singular covariance matrices
zerodist(station_coords)

# Time stamps
time <- as.POSIXct(unique(agg4$YEAR),tz="", "%Y")

# Temperature values
values <- agg4$MEAN_TEMP

# Create STFDF object (for static spatial instances)
df <- data.frame(values = values)
st_object <- STFDF(station_coords,time,data=df)
```

Plot STFDF data
```{r Plot STFF data, echo=TRUE}
# Pull map of Croatia
map.cro = map2SpatialLines(map("world", "croatia", fill=TRUE, ol="transparent", plot=F))
proj4string(map.cro) = "+init=epsg:4326"
map.cro = spTransform(map.cro, "+init=epsg:3765")

# Plot multi-panel plots, one panel for every year showing locations in the country with colors for average temperature
layout = list(list("sp.lines", map.cro, col='grey'),list("sp.points", station_coords, first=F, cex=.5))
stplot(st_object, sp.layout = layout)


# Time series of temperature for every station
stplot(st_object, mode="tp")

# Time series of temperature for all stations
stplot(st_object, mode="ts")

# Plot space-time plots
scales=list(x=list(rot = 45))
stplot(st_object, mode = "xt", cuts=11,scales = scales, xlab = NULL,col.regions=rev(brewer.pal(11, "RdBu")))
```
Now we will create sample spatio-temporal variogram using all data from all stations.
```{r Create sample spatio-temporal variogram, echo=TRUE}
# Create sample spatio-temporal variogram
sampl.var <- variogramST(values~1,data=st_object)

# Plot 2D plot of variogram
plot(sampl.var, map=F)

# Plot 2D map of variogram
plot(sampl.var, map=T)

# Plot 3D variogram
plot(sampl.var, wireframe=T)
```
This is a dummy spatial variogram used to fine-tune parameters which will be used later on in fitting of spatio-temporal variogram.
```{r Create sample spatial variogram, echo=TRUE}
# Get lag for year 2012
lag8 <- subset(agg4, YEAR == "2012" )

# Set CRS
crs = st_crs("EPSG:3765")

# Create file for use when constructing variogram
lag8.sf = st_as_sf(lag8, coords = c("LONG", "LAT"), crs = "EPSG:4326") %>%
    st_transform(crs)

# Create sample spatial variogram
v = variogram(MEAN_TEMP~1, lag8.sf)

# Save desired parameters (these were achieved experimentally)
lag8_spatial_var_model <- vgm(10, "Exp", 70000)

# Plot variogram
plot(v,lag8_spatial_var_model,plot.numbers=TRUE)
```

Now we create models for spatio-temporal variogram and try to fit them:
```{r Fit variogram, echo=TRUE, message=FALSE}
# We have 5 options for fitting; separable, product sum, metric, sum metric, and simple sum metric.
# First thing is to set lower and upper limits for all models
pars.l <- c(sill.s = 0, range.s = 10, nugget.s = 0,sill.t = 0, range.t = 1, nugget.t = 0,sill.st = 0, range.st = 10, nugget.st = 0, anis = 0)
pars.u <- c(sill.s = 10000, range.s = 50000, nugget.s = 100,sill.t = 100000, range.t = 50000, nugget.t = 100,sill.st = 10000, range.st = 50000, nugget.st = 100,anis = 700) 
# ------------------------------------------------------------------------------
# Separable model 
separable <- vgmST("separable", space = vgm(10,"Exp",60000,0),time = vgm(100,"Exp",500,1), sill=1)
separable_fitted <- fit.StVariogram(sampl.var, separable, fit.method=11,method="L-BFGS-B", stAni=1)
print(paste("MSE for Separable model is: ",attr(separable_fitted, "MSE")))
# ------------------------------------------------------------------------------
# Product sum model
prodSumModel <- vgmST("productSum", space = vgm(10,"Exp",60000,0),time = vgm(psill=500,"Exp", range=5000, nugget=0), k=500)
prodSumModel_fitted <- fit.StVariogram(sampl.var, prodSumModel,method = "L-BFGS-B",lower=pars.l)
print(paste("MSE for Product sum model is: ",attr(prodSumModel_fitted, "MSE")))
# ------------------------------------------------------------------------------
# Metric
metric <- vgmST("metric",joint=vgm(10,"Exp",70000,0),stAni=1)
metric_fitted <- fit.StVariogram(sampl.var, metric)
print(paste("MSE for Metric model is: ",attr(metric_fitted, "MSE")))
# ------------------------------------------------------------------------------
# Sum metric
sumMetric <- vgmST("sumMetric", space = vgm(10,"Exp",60000,0),time = vgm(psill=500,"Exp", range=5000, nugget=0), joint = vgm(25,"Exp",60000,0), stAni=500) 
sumMetric_fitted <- fit.StVariogram(sampl.var, sumMetric, method="L-BFGS-B",tunit="hours")
print(paste("MSE for Sum metric model is: ",attr(sumMetric_fitted, "MSE")))
# ------------------------------------------------------------------------------
# Simple sum metric
SimplesumMetric <- vgmST("simpleSumMetric",space = vgm(10,"Exp",60000,0),time = vgm(500,"Exp", 5000, 0), joint = vgm(25,"Exp",60000,0), nugget=1, stAni=500)
SimplesumMetric_fitted <- fit.StVariogram(sampl.var, SimplesumMetric,method = "L-BFGS-B")
print(paste("MSE for Simple sum metric model is: ",attr(SimplesumMetric_fitted, "MSE")))
# ------------------------------------------------------------------------------
# Plot 3D plots for models
plot(sampl.var,list(separable_fitted,prodSumModel_fitted,metric_fitted, sumMetric_fitted, SimplesumMetric_fitted),all=T,wireframe=T)
```
Load Croatian map
```{r Load map of Croatia, echo=TRUE, message=FALSE}
croatia_sea <- st_read("HRV_adm/croatia.geojson")
croatia_land <- st_read("HRV_adm/croatia_land.geojson")
single_sf <- bind_rows(list(croatia_sea,croatia_land))
```

Create map for Croatia together with stations.
```{r Croatia map, fig.align='center',fig.width=10, fig.height=7, include=TRUE, results='hide'}
stations_only <- data.frame(LON = agg4$LONG[1:30], LAT = agg4$LAT[1:30])
NAME <- c(agg4$NAME[1:30])
stations_only <- cbind(stations_only,NAME)
plot_with_points <- ggplot() +
  geom_sf(data = single_sf) +
  geom_point(data = stations_only,
             mapping = aes(x = LON, y = LAT),
             colour = "red",
             size = 2,
             shape = 4) +
  coord_sf()

plot_with_points + 
  geom_label_repel(data = stations_only, aes(x = LON, y = LAT,label = NAME),
                  box.padding   = 0.1, 
                  point.padding = 0.5,
                  segment.color = 'grey50') +
  theme_classic()
```
For some reason, grid is created for rectangle and for Croatian boundaries. There are different values inside grid cells depending one the position of cell. I will assign NA value to cells outside Croatian boundary, and value 0 to cells inside Croatia.
```{r Create grid, eval=FALSE}
croatia_grid_sf <- st_read("Croatia_shapefile/hr_10km.shp")
croatia_grid_sf <- st_transform(croatia_grid_sf,3765)
croatia_bbox <- st_as_sfc(st_bbox(croatia_grid_sf))
croatia_outer_border <- st_intersection(croatia_bbox,croatia_grid_sf)
croatia_grid_stars <- st_as_stars(croatia_outer_border)

#replace bin values
for (x in 1:246) {
  for (y in 1:264) {
    if (croatia_grid_stars[[1]][x:x,y:y] == 0) {
      croatia_grid_stars[[1]][x:x,y:y] <- NA
    } 
    else {
      croatia_grid_stars[[1]][x:x,y:y] <- 0
    }
  }
}
```
Proceed to kriging and display results.
```{r, echo=TRUE, error=FALSE, warning=FALSE}
# Create spatial grid
spatial.grid = SpatialPixels(SpatialPoints(makegrid(map.cro, n = 10000)),
                             proj4string = proj4string(map.cro))

# Create temporal grid
tgrd = seq(min(index(st_object)), max(index(st_object)), length=16)

# Merge two grids into spatio-temporal grid
pred.grd = STF(spatial.grid, tgrd)

# Assign same proj4string due to some issues of two strings not being equal
proj4string(st_object) = proj4string(pred.grd)

# Krige
temp.ST = krigeST(values ~ 1, st_object, pred.grd, metric_fitted)

# Pack borders and stations
layout = list(list("sp.lines", map.cro, col='grey'),list("sp.points", station_coords, first=F, cex=.5))

# Plot all together
stplot(temp.ST,cuts=11,col.regions=rev(brewer.pal(11, "RdBu")), sp.layout = layout)
```
## 5. References 

[1] NOAA https://www.ncei.noaa.gov

[2] Sekulić, A., Kilibarda, M., Protić, D. et al. Spatio-temporal regression kriging model of mean daily temperature for Croatia. Theor Appl Climatol 140, 101–114 (2020). https://doi.org/10.1007/s00704-019-03077-3

[3] Hengl, T., Heuvelink, G.B.M., Perčec Tadić, M. et al. Spatio-temporal prediction of daily temperatures using time-series of MODIS LST images. Theor Appl Climatol 107, 265–277 (2012). https://doi.org/10.1007/s00704-011-0464-2

[4] https://www.r-bloggers.com/2015/08/spatio-temporal-kriging-in-r/
